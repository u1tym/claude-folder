# データベースストレージ移行ガイド

## 概要

このプロジェクトは、ファイルを物理的なファイルシステムからデータベースに保存する方式に変更されました。

## 主な変更点

### 1. データベーススキーマの変更

**変更前:**
- `FileVersion` テーブルに `file_path` カラム（物理ファイルパス）
- ファイルは `uploads/` ディレクトリに物理保存

**変更後:**
- `FileVersion` テーブルに `file_content` カラム（LargeBinary）
- ファイルコンテンツをデータベースに直接保存

### 2. バックエンドの変更

#### `app/database.py`
- `LargeBinary` インポートを追加
- `FileVersion` モデルに `file_content` カラムを追加
- `file_path` カラムを削除

#### `app/services.py`
- 物理ファイル操作を削除
- ファイルコンテンツをデータベースに直接保存
- 古いバージョンのクリーンアップ処理を更新

#### `app/main.py`
- ファイルダウンロード処理を `StreamingResponse` に変更
- データベースからファイルコンテンツを取得してストリーミング

### 3. フロントエンド

- 削除されたファイルも一覧に表示されるように修正
- 削除されたファイルは視覚的に区別される（赤色、取り消し線、ゴミ箱アイコン）
- 削除されたファイルもダウンロード可能（「削除版をダウンロード」ボタン）
- バージョン履歴で削除されたファイルもダウンロード可能

## 移行手順

### 1. データベースの初期化

```bash
# 新しいスキーマでデータベースを初期化
python init_db.py
```

### 2. 既存データの移行（オプション）

既存のファイルシステムベースのデータがある場合：

```bash
# 既存ファイルをデータベースに移行
python migrate_to_db_storage.py
```

### 3. テストの実行

```bash
# データベースストレージのテスト
python test_db_storage.py
```

### 4. アプリケーションの起動

```bash
# バックエンドの起動
python -m uvicorn app.main:app --reload

# フロントエンドの起動（別ターミナル）
cd frontend
npm run dev
```

## 利点

1. **データの整合性**: ファイルとメタデータが同じデータベースに保存される
2. **バックアップの簡素化**: データベースのバックアップだけでファイルも含まれる
3. **スケーラビリティ**: ファイルシステムの制限を受けない
4. **トランザクション**: ファイル操作とメタデータ更新を同一トランザクションで実行可能
5. **削除されたファイルの復旧**: 3世代以内の削除されたファイルもダウンロード可能
6. **視覚的な区別**: 削除されたファイルは一覧で視覚的に区別される

## 注意事項

1. **データベースサイズ**: ファイルコンテンツがデータベースに保存されるため、データベースサイズが増加します
2. **パフォーマンス**: 大きなファイルの場合、メモリ使用量が増加する可能性があります
3. **バックアップ**: データベースのバックアップ時間が長くなる可能性があります

## トラブルシューティング

### データベース接続エラー
- PostgreSQLが起動していることを確認
- 接続文字列（`DATABASE_URL`）が正しいことを確認

### メモリ不足エラー
- 大きなファイルをアップロードする際は、チャンク単位での処理を検討
- データベースのメモリ設定を調整

### 移行エラー
- 既存の `uploads/` ディレクトリの権限を確認
- データベースの容量を確認
